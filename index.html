<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tamagotchi V4 Logout</title>

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="Tama V4">

<style>
body {
    font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    background: #111;
    color: #0f0;
    padding: 20px;
}
input, button {
    width: 100%;
    padding: 10px;
    margin: 6px 0;
    font-size: 16px;
}
button {
    background: #0f0;
    color: #000;
    border: none;
    font-weight: bold;
}
.output {
    font-family: monospace;
    font-size: 22px;
    margin-top: 10px;
}
.scan {
    background: #222;
    color: #0f0;
    border: 1px solid #0f0;
}
</style>
</head>

<body>

<h2>Tamagotchi V4 Logout</h2>

<input id="username" value="JABA">

<input id="loginUp" placeholder="Login ligne 1">
<input id="loginDown" placeholder="Login ligne 2">

<input id="points" placeholder="Points (0â€“9900)">

<button class="scan" onclick="document.getElementById('photo').click()">ðŸ“¸ Scanner le Tamagotchi</button>
<input type="file" id="photo" accept="image/*" capture="environment" style="display:none" onchange="scanImage(this)">

<button onclick="generate()">GÃ‰NÃ‰RER</button>

<div class="output" id="outUp"></div>
<div class="output" id="outDown"></div>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

<script>
const ITER = [70,101,4,35,66,97,15,32,126,24,57,90,123,28,61,40];
const CHARACTERS = "ABCDEFGHIJ!?KLMNOPQRSTUVWXYZ ";

function getChar(c){ return CHARACTERS.indexOf(c)+1; }

function cleanHex(s){
    return s.replace(/O/g,"0").replace(/I/g,"1").replace(/S/g,"5").replace(/B/g,"8")
            .replace(/[^0-9A-F]/g,"");
}

async function scanImage(input){
    const file = input.files[0];
    if(!file) return;

    const imgURL = URL.createObjectURL(file);

    const result = await Tesseract.recognize(imgURL, 'eng');
    let text = result.data.text.toUpperCase();

    let matches = text.split(/\s+/).map(cleanHex).filter(s => s.length === 7);

    if(matches.length >= 2){
        document.getElementById("loginUp").value = matches[0];
        document.getElementById("loginDown").value = matches[1];
    } else {
        alert("Impossible de lire les 2 lignes du mot de passe. Essaie une photo plus nette.");
    }
}

function generate(){
    let u=(document.getElementById("username").value+"     ").slice(0,5);
    let up=document.getElementById("loginUp").value;
    let down=document.getElementById("loginDown").value;
    let pts=parseInt(document.getElementById("points").value);

    let pw=(down+up);
    let pwb=[];
    for(let i=0;i<7;i++) pwb[i]=parseInt(pw.substr(i*2,2),16);

    let L=[...u].map(getChar);
    let ub=[];
    ub[0]=0;
    ub[1]=(16*(L[4]%16))+(L[3]>>3);
    ub[2]=(32*(L[3]%8))+(2*(L[3]%16));
    ub[3]=(4*(L[2]%32))+(L[2]>>2);
    ub[4]=(64*(L[2]%4))+(L[1]>>1);
    ub[5]=(128*(L[1]%2))+(8*(L[1]%16))+(L[0]>>4);
    ub[6]=(16*(L[0]%16))+(L[0]%16);

    let d=[];
    for(let i=0;i<7;i++) d[i]=pwb[i]^ub[i];

    let it=ITER[d[0]>>4]^(((d[0]&15)*109)&255);
    for(let i=1;i<7;i++) d[i]^=it;

    let out=[...d];
    let pe=((pts/1000|0)*16)+((pts/100|0)%10);
    out[0]%=16;
    out[1]^=pe;
    out[6]^=128;

    let cs=0;
    for(let b of out) cs+=(b>>4)+(b&15);
    cs%=16;
    out[0]+=16*(16-cs);

    let it2=ITER[out[0]>>4]^(((out[0]&15)*109)&255);
    for(let i=1;i<7;i++) out[i]^=it2;
    for(let i=0;i<7;i++) out[i]^=ub[i];

    let hex=out.map(b=>("0"+b.toString(16)).slice(-2).toUpperCase()).join("");

    document.getElementById("outUp").innerText=hex.substr(7,7);
    document.getElementById("outDown").innerText=hex.substr(0,7);
}
</script>

</body>
</html>